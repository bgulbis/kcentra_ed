WITH PATIENTS AS (
	SELECT DISTINCT
		ENCOUNTER.ENCNTR_ID,
		ENCOUNTER.LOC_FACILITY_CD
	FROM
		CLINICAL_EVENT,
		DIAGNOSIS,
		ENCOUNTER,
		NOMENCLATURE
	WHERE
		CLINICAL_EVENT.EVENT_CD = 926562948 -- prothrombin complex
		AND CLINICAL_EVENT.VALID_UNTIL_DT_TM > DATE '2099-12-31' 
		AND CLINICAL_EVENT.EVENT_END_DT_TM BETWEEN DATE '2015-09-01' AND DATE '2019-09-01'
		AND (
			CLINICAL_EVENT.ENCNTR_ID = ENCOUNTER.ENCNTR_ID
			AND ENCOUNTER.ACTIVE_IND = 1
			AND ENCOUNTER.LOC_FACILITY_CD IN (
				3310, -- HH HERMANN
				3796, -- HC Childrens
				3821, -- HH Clinics
				3822, -- HH Trans Care
				3823, -- HH Rehab
				95507, -- HH Comp Rehab C
				9326931, -- KM Katy
				9327051, -- SG Sugar Land
				9351014, -- MC Mem City
				9351079, -- GH Greater Heights
				9351108, -- SE Southeast
				9351114, -- SW Southwest
				9351127, -- TW The Woodland
				119535990, -- TR TIRR
				171202052, -- NE Northeast
				239872367, -- Memorial Hermann First Colony Hospital
				1788535501, -- HY OSH
				1824255295, --- BL PEARLAND
				2185384654, -- CY CYPRESS
				2801312741 -- MEMORIAL HERMANN TOMBALL HOSPITAL
			)
		)
		AND (
			CLINICAL_EVENT.ENCNTR_ID = DIAGNOSIS.ENCNTR_ID
			AND DIAGNOSIS.ACTIVE_IND = 1
			AND DIAGNOSIS.DIAG_TYPE_CD = 26244 -- Final
		)
		AND (
			DIAGNOSIS.NOMENCLATURE_ID = NOMENCLATURE.NOMENCLATURE_ID
			AND NOMENCLATURE.ACTIVE_IND = 1
			AND REGEXP_INSTR(NOMENCLATURE.SOURCE_IDENTIFIER, 'I61|I62') > 0
		)

	UNION

	SELECT DISTINCT
		ENCOUNTER.ENCNTR_ID,
		ENCOUNTER.LOC_FACILITY_CD
	FROM
		CLINICAL_EVENT,
		DIAGNOSIS,
		ENCOUNTER,
		NOMENCLATURE
	WHERE
		CLINICAL_EVENT.EVENT_CD = 926562948 -- prothrombin complex
		AND CLINICAL_EVENT.VALID_UNTIL_DT_TM > DATE '2099-12-31' 
		AND CLINICAL_EVENT.EVENT_END_DT_TM BETWEEN DATE '2013-05-01' AND DATE '2015-11-01'
		AND (
			CLINICAL_EVENT.ENCNTR_ID = ENCOUNTER.ENCNTR_ID
			AND ENCOUNTER.ACTIVE_IND = 1
			AND ENCOUNTER.LOC_FACILITY_CD IN (
				3310, -- HH HERMANN
				3796, -- HC Childrens
				3821, -- HH Clinics
				3822, -- HH Trans Care
				3823, -- HH Rehab
				95507, -- HH Comp Rehab C
				9326931, -- KM Katy
				9327051, -- SG Sugar Land
				9351014, -- MC Mem City
				9351079, -- GH Greater Heights
				9351108, -- SE Southeast
				9351114, -- SW Southwest
				9351127, -- TW The Woodland
				119535990, -- TR TIRR
				171202052, -- NE Northeast
				239872367, -- Memorial Hermann First Colony Hospital
				1788535501, -- HY OSH
				1824255295, --- BL PEARLAND
				2185384654, -- CY CYPRESS
				2801312741 -- MEMORIAL HERMANN TOMBALL HOSPITAL
			)
		)
		AND (
			CLINICAL_EVENT.ENCNTR_ID = DIAGNOSIS.ENCNTR_ID
			AND DIAGNOSIS.ACTIVE_IND = 1
			AND DIAGNOSIS.DIAG_TYPE_CD = 26244 -- Final
		)
		AND (
			DIAGNOSIS.NOMENCLATURE_ID = NOMENCLATURE.NOMENCLATURE_ID
			AND NOMENCLATURE.ACTIVE_IND = 1
			AND REGEXP_INSTR(NOMENCLATURE.SOURCE_IDENTIFIER, '431|432.9') > 0
		)
)

SELECT DISTINCT
	pi_get_cv_display(PATIENTS.LOC_FACILITY_CD) AS FACILITY,
	COUNT(DISTINCT PATIENTS.ENCNTR_ID) AS NUM_PTS
FROM
	PATIENTS
GROUP BY
	PATIENTS.LOC_FACILITY_CD